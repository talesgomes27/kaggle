---
title: "Forest_fires_in_Brazil"
author: "Tales Gomes"
date: "11/09/2021"
output: 
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  error = FALSE,
  warning = FALSE,
  out.width = "100%",
  fig.path = "images/",
  fig.align = "center",
  dpi = 400
  )
```

## Projeto

Neste exercício irei trabalhar com o banco de dados do kaggle [Forest Fires in Brazil](https://www.kaggle.com/gustavomodelli/forest-fires-in-brazil) que comporta o número de focos de incêndio em florestas brasileiras do ano de 1998 até 2017, os dados foram obtidos a partir do [site oficial](https://dados.gov.br/dataset/sistema-nacional-de-informacoes-florestais-snif) do governo brasileiro.

## Objetivo

Neste exercício o ejetivo é encontrar padrões nos dados, além de trinar visualizações com mapas utilizando o pacote [sf](https://r-spatial.github.io/sf/) em conjunto com o pacote [geobr](https://ipeagit.github.io/geobr/index.html), ambos da biblioteca [R](https://www.r-project.org/about.html).

![](images/think.gif){width="680"}

Encontrar padrões? Muito genérico! Então para me guiar neste trabalho irei realizar alguns questionamentos básicos, que espero poder responder no decorrer do exercício. São eles:

1.  Qual o Estado e região brasileirs com mais focos de incêndio em florestas?

2.  Qual o Estado e região com menos focos?

3.  Na região norte qual o estado com mais focos de incêndio?

4.  No estado do Pará qual o mês com mais focos de incêndios na média?

5.  No ano de 2010, qual foi o estado com mais focos de incêndio no Brasil?

6.  No ano de 2010, qual o mês com menos focos de incêndio no estado do Pará?

Nas perguntas preliminares fiz questão de incluir a região norte e o estado do Pará, bem, por que não?

![](images/calypso.gif){width="645"}

## Preparação

```{r include=FALSE}
# Antes de tudo definirei os temas que serão utilizados para os gráfico gerados nesse projeto.

# Tema para ser utilizado nos mapas
theme_map <- function(...) {
  ggthemes::theme_base() +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      #panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#F9F7F7", color = NA), 
      panel.background = element_rect(fill = "#F9F7F7", color = NA), 
      legend.background = element_rect(fill = "#F9F7F7", color = NA),
      panel.border = element_blank(),
      ...
    )
}

#Tema para demais visualizações
theme_ggplot <- function(...) {
  ggthemes::theme_base() +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.text.y = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      #panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      legend.position = "bottom",
      ...
    )
}
```

```{r include=FALSE}
# Carregando bibliotecas --------------------------------------------------
# Dados encontrados em
# https://dados.gov.br/dataset/sistema-nacional-de-informacoes-florestais-snif/resource/39308794-da81-4cab-89e7-1691c2f3893b
#Projeto kaggle referência.
# https://www.kaggle.com/gustavomodelli/forest-fires-in-brazil
library(tidyverse)
library(sf)
library(geobr)
library(reactable)

# Obtendo os dados --------------------------------------------------------
estados <- read_state()
regioes <- read_region()
```

Ao tentar carregar no R a [planilha](http://homolog-dados.mma.gov.br/pt_BR/dataset/ffd9ab35-5719-4ec1-8d13-ae8f738bebc2/resource/949310f1-05bc-4f56-a63f-aef67aac6164/download/rf_incendiosflorestais_focoscalor_estados_1998-2017.csv) obtida através do site oficial do governo brasileiro encontrei alguns problemas, uma vez que a pessoa que salvou o arquivo ".csv" incluiu aspas no começo e final de cada linha, o que fez com que a primeira coluna comece com aspas, o que não é um nome de variavel válido no R. Além das aspas a codificação do arquivo não era UTF-8, o que não facilitou minha vida. Abaixo mostro a tabela nenhum tratamento.

```{r}

site <- "http://homolog-dados.mma.gov.br/pt_BR/dataset/ffd9ab35-5719-4ec1-8d13-ae8f738bebc2/resource/949310f1-05bc-4f56-a63f-aef67aac6164/download/rf_incendiosflorestais_focoscalor_estados_1998-2017.csv"
dados <- data.table::fread(site)

head(dados)
```

### Aquisição dos dados

Depois de muito bater cabeça encontrei o função *fread* do pacote [*data.table*](https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html) que possui argumentos muito úteis para lidar com esse problema. Basicamente a função leu na codificação correta e removeu das variáveis as aspas que estavam causando erro na leitura. Bem simples, não?

Voltando aos dados! O banco de dados é composto por uma planilha com 5 colunas e 6454 linhas que contém o número de incẽndios, bem como o estados, mês e ano que esses incêndios ocorreram. Abaixo podemos ver a tabela após o tratamento inicial.

```{r}

dados <- data.table::fread(site, encoding = 'Latin-1', check.names = TRUE)


```

```{r}
reactable(dados, paginationType = "jump", columns = list(
  X.Ano = colDef(
    cell = function(value) {
      htmltools::tags$b(value)
    }
  )
))
```

### Tratamento dos dados

O processo de tratamento é descrito a seguir:

-   Há duas formas de trabalhar com datas aqui, a primeira é utilizar a coluna "Período." que contém informações completas de mês e ano. A segunda forma é utilizar as colunas "X.Ano" e "Mês" que possuem as mesmas informações. Para simplificar as coisas irei trabalhar com as colunas "X.Ano" e "Mês" e por isso o primeiro passo da limpeza é excluir a coluna "Período." (Fica de exercício fazer o oposto e tratar a coluna "Período." com o pacote [*lubridate*](https://lubridate.tidyverse.org/) do tidyverse para extrair o mês e o ano).

-   Segundo passo é renomear minhas colunas para melhor gerais, retirar acentos e formatar a nomeação das variáveis.

-   Por último retirei da primeira e ultima coluna dos dados as aspas e mudei o tipo das variáveis para melhor trabalhar com os dados.

Além dos dados dos incêndios precisamos também precisamos das coordenadas geográficas para podermos visualizar os mapas, aqui foi utilizado o pacote [geobr](https://ipeagit.github.io/geobr/index.html) que possui as coordenadas do território brasileiro (Pais, regiões, estados e municípios) em um formato pronto para trabalhar com o pacote [sf](https://r-spatial.github.io/sf/), o que facilitou bastante o trabalho. Neste trabalho utilizei o banco de dados contendo as informações dos estados e outro contendo as informações das regiões. Único tratamento que precisei fazer foi alterar a coluna que contém o nome dos estados para coincidir com a tabela dos dados. Abaixo o código com o tratamento dos dados:

```{r}
# Renomeando as variáveis, removendo as aspas e convertendo formatos.
dados <- dados |> 
  select(-Período.) |> 
  rename(ANO = X.Ano,
         UF = Estado,
         MES = Mês,
         N_calor = Número,
         ) |> 
  mutate(
    ANO = str_remove(ANO,"\""),
    ANO = as.double(ANO),
    N_calor = as.integer(N_calor),
    UF = factor(janitor::make_clean_names(UF, case = "title", unique_sep = ".")),
    UF = str_replace(UF,"\\..*","")
    )
#tratando o objeto "estados" do pacote  "geobr" para que a coluna "name_state"
#corresponda com a coluna "UF" do "dados".
estados <- estados |>  
  mutate(
    name_state = factor(janitor::make_clean_names(name_state, case = "title", unique_sep = ".")),
    name_state = str_replace(name_state,"\\..*",""))

```

Abaixo a tabela resultante:

```{r}
reactable(dados, paginationType = "jump", filterable = TRUE,
          columns = list(
            ANO = colDef(
              cell = function(value) {
                htmltools::tags$b(value)
                }
              )
            )
          )

```

Agora possuo três tabela diferentes (Dados de incêndio, Estados e Regiões) com todas as informações que preciso, então como próximo passo realizei a união das tabelas com o o pacote [dplyr](https://dplyr.tidyverse.org/reference/join.html) e o conjunto de junções [join](https://www.w3schools.com/sql/sql_join.asp) que ele possui.

Lembra dos questionamentos iniciais que fiz? Pois bem, para poder responde-los precisarei ser capaz de filtrar por ano, estado, mês e região. Então no final da união das tabela fiquei com três tabelas diferentes, para assim poder encontrar os dados correspondentes a cada pergunta. Abaixo o código para gerar cada uma das tabelas finais.

-   Tabela 1:

    -   Aqui unimos a tabela "dados" com a "estados" para análise por ano, excluindo a coluna "MES" e calculando o numero de focos de incêndio por ano.

    ```{r echo=TRUE}

    foco_calor_ano <- dados |> 
      select(-MES) |> 
      with_groups(c(ANO, UF),
                  summarise,
                  ANO,UF,
                  N_calor = sum(N_calor)
                  ) |> 
      unique() |> 
      right_join(estados, by = c("UF" = "name_state")) |> 
      st_as_sf()
    ```

-   Tabela 2:

    -    União da tabela "dados com estados" contudo sem excluir a tabela mês, assim agrupando os dados por mês obtemos o total de focos de incêndios mensais.

    ```{r echo=TRUE}

    foco_calor_mes <- dados |> 
      group_by(UF, ANO, MES) |> 
      summarise(UF, ANO,
                N_calor= sum(N_calor),
                MES = ordered(MES, levels = c("Janeiro", "Fevereiro", "Março", "Abril",
                                              "Maio", "Junho", "Julho", "Agosto",
                                              "Setembro", "Outubro", "Novembro",
                                              "Dezembro"))) |> 
      right_join(estados, by = c("UF" = "name_state")) |> 
      unique() |> 
      st_as_sf() 

    ```

-   Tabela 3:

    -   Tabela resultante da união da tabela "regioes" com a tabela "dados", excluindo a coluna "MES" e calculando o total por ano.

    ```{r echo=TRUE}

    foco_calor_regiao <- dados |>
      right_join(estados, by = c("UF" = "name_state")) |> 
      select(-c("abbrev_state", "code_state", "UF", "MES", "geom", "code_region")) |> 
      group_by(ANO, name_region) |> 
      mutate(N_calor = sum(N_calor)) |> 
      unique() |> 
      right_join(regioes, by = c("name_region" = "name_region")) |> 
      st_as_sf()

    ```

## Análise

Depois de tratar os dados podemos enfim responder as perguntas iniciais.

1.  Qual o Estado e região brasileiras com mais focos de incêndio em florestas?

    ```{r}

    foco_calor_ano |> 
      ggplot(aes(N_calor, reorder(UF, -N_calor))) +
      geom_col(aes(color = name_region, fill = name_region), width = 0.8)+
      scale_color_viridis_d()+
      scale_fill_viridis_d()+
      labs(
        title = "Quantidade de focos de incêndio no Brasil",
        subtitle = "de 1998 a 2017",
        y = "Estados",
        x = "Número de focos de incêndio",
        color = "Região",
        fill = "Região"
      )+
      theme_ggplot()

    ```

2.  Qual o Estado e região com menos focos?

3.  Na região norte qual o estado com mais focos de incêndio?

4.  No estado do Pará qual o mês com mais focos de incêndios na média?

5.  No ano de 2010, qual foi o estado com mais focos de incêndio no Brasil?

6.  No ano de 2010, qual o mês com menos focos de incêndio no estado do Pará?

Nas perguntas preliminares fiz questão de incluir a região norte e o estado do Pará, bem, por que não?
